<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | Smart Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #camera-feed { width: 100%; max-width: 100%; border-radius: 12px; background: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .camera-container { position: relative; overflow: hidden; }
        .overlay-guide {
            position: absolute; top: 10%; left: 20%; right: 20%; bottom: 10%;
            border: 2px dashed rgba(255, 255, 255, 0.5); border-radius: 50%; pointer-events: none;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4" style="max-width: 500px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 fw-bold">üì∏ Mark Attendance</h4>
        <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <label class="form-label fw-bold text-muted small uppercase">Select Active Class</label>
            <select id="session-selector" class="form-select form-select-lg">
                <option value="" selected disabled>-- Choose a Class --</option>
                {% for session in active_sessions %}
                    <option value="{{ session.id }}">
                        {{ session.course.name }} (Ends in {{ session.duration_minutes }}m)
                    </option>
                {% empty %}
                    <option value="" disabled>üö´ No Active Classes Found</option>
                {% endfor %}
            </select>
            {% if not active_sessions %}
                <div class="mt-2 alert alert-warning small py-1">
                    No classes are running right now. Tell your faculty to start a session.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="camera-container mb-3">
        <video id="camera-feed" autoplay playsinline></video>
        <div class="overlay-guide"></div> <canvas id="snapshot-canvas" class="hidden"></canvas>
    </div>

    <div class="d-grid gap-2">
        <button id="btn-mark" class="btn btn-primary btn-lg py-3 fw-bold" disabled>
            Mark Attendance
        </button>
    </div>

    <div class="mt-3 text-center">
        <span id="location-status" class="badge bg-secondary">üìç Waiting for GPS...</span>
    </div>

</div>

<script>
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('snapshot-canvas');
    const btnMark = document.getElementById('btn-mark');
    const locStatus = document.getElementById('location-status');
    const sessionSelect = document.getElementById('session-selector');
    
    let currentLat = null;
    let currentLong = null;

    // 1. Start Camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => { video.srcObject = stream; })
        .catch(err => { 
            alert("Camera Error: " + err); 
            locStatus.className = "badge bg-danger";
            locStatus.innerText = "Camera Blocked";
        });

    // 2. Start GPS
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLong = position.coords.longitude;
                locStatus.className = "badge bg-success";
                locStatus.innerText = `üìç GPS Ready`;
                checkReadiness(); // Check if we can enable the button
            },
            (err) => { 
                locStatus.className = "badge bg-danger";
                locStatus.innerText = "‚ùå GPS Permission Denied"; 
            },
            { enableHighAccuracy: true }
        );
    } else {
        locStatus.innerText = "‚ùå GPS not supported";
    }

    // 3. Enable Button only if Class Selected AND GPS Ready
    function checkReadiness() {
        if (currentLat && sessionSelect.value) {
            btnMark.disabled = false;
            btnMark.innerText = "Mark Attendance";
            btnMark.classList.remove('btn-secondary');
            btnMark.classList.add('btn-primary');
        } else {
            btnMark.disabled = true;
            if (!sessionSelect.value) btnMark.innerText = "Select a Class First";
            else if (!currentLat) btnMark.innerText = "Waiting for GPS...";
        }
    }

    // Listen for dropdown changes
    sessionSelect.addEventListener('change', checkReadiness);

    // 4. Handle Submit
    btnMark.addEventListener('click', () => {
        const sessionId = sessionSelect.value;
        if (!sessionId) { alert("Please select a class!"); return; }

        // Capture
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob((blob) => {
            const formData = new FormData();
            formData.append('session', sessionId); // Send the SELECTED session ID
            formData.append('captured_image', blob, 'attendance.jpg');
            formData.append('gps_lat', currentLat);
            formData.append('gps_long', currentLong);

            btnMark.innerText = "Verifying...";
            btnMark.disabled = true;

            fetch('/api/mark-attendance/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Inside the .then(data => { ... }) block

if(data.message) {
    // Show the "Success Card" with details
    document.body.innerHTML = `
        <div class="container mt-5 text-center">
            <div class="card shadow-lg border-success">
                <div class="card-header bg-success text-white">
                    <h2 class="mb-0">‚úÖ Attendance Marked</h2>
                </div>
                <div class="card-body p-5">
                    <h1 class="display-1 text-success mb-4">üëç</h1>
                    
                    <h4 class="fw-bold">${data.class_name}</h4>
                    <p class="lead text-muted">Topic: ${data.topic}</p>
                    <hr>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <small class="text-uppercase text-muted">Faculty</small><br>
                            <strong>${data.faculty_name}</strong>
                        </div>
                        <div class="col-auto">
                            <small class="text-uppercase text-muted">Time</small><br>
                            <strong>${new Date().toLocaleTimeString()}</strong>
                        </div>
                    </div>
                    
                    <a href="/student/" class="btn btn-primary mt-4">Done</a>
                </div>
            </div>
        </div>
    `;
} else {
    // Error Handling
    alert("‚ùå Error: " + (data.error || "Unknown Error"));
    btnMark.innerText = "Try Again";
    btnMark.disabled = false;
}
            })
            .catch(err => {
                alert("Server Error: " + err);
                btnMark.disabled = false;
            });
        }, 'image/jpeg');
    });
</script>

</body>
</html>